#!/usr/bin/env bash

# exit immediately if a command exists with a non-zero code (errors or fails)
set -e

# some constants
DOTFILES_DIR="$HOME/.dotfiles"
SSH_DIR="$HOME/.ssh"

# generate ssh keys
if ! [[ -f "$SSH_DIR/authorized_keys" ]]; then
	mkdir -p "$SSH_DIR"
	chmod 700 "$SSH_DIR"
	ssh-keygen -b 4096 -t rsa -f "$SSH_DIR/id_rsa" -N "" -C "$USER@$HOSTNAME"
	cat "$SSH_DIR/id_rsa.pub" | tee "$SSH_DIR/authorized_keys"
fi


# update git repository
if ! [[ -d "$DOTFILES_DIR" ]]; then
	git clone "https://github.com/gh-jsoares/dotfiles-new.git"
else
	git -C "$DOTFILES_DIR" pull
fi


# install ansible if not installed
if ! [ -x "$(command -v ansible)" ]; then
	sudo apt install -y ansible
fi

# install requirements for ansible if needed
if [[ -f "$DOTFILES_DIR/requirements.yml" ]]; then
	cd "$DOTFILES_DIR"
	ansible-galaxy install -r requirements.yml
fi

# run the ansible playbook and all its roles
if [[ -f "$DOTFILES_DIR/vault.password" ]]; then
	ansible-playbook --diff --extra-vars "@$DOTFILES_DIR/values.yml" --vault-password-file "$DOTFILES_DIR/vault.password" "$DOTFILES_DIR/main.yml" --become -e "ansible_python_interpreter=/usr/bin/python3" "$@"
else
	ansible-playbook --diff --extra-vars "@$DOTFILES_DIR/values.yml" "$DOTFILES_DIR/main.yml" --become -e "ansible_python_interpreter=/usr/bin/python3" "$@"
fi
